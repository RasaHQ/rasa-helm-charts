name: Lint

on:
  pull_request:
    types: [opened, synchronize, labeled, edited]

jobs:
  lint:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.sha }}

    - name: Fetch history
      run: git fetch --prune

    - name: Install Helm 3
      uses: azure/setup-helm@5119fcb9089d432beecbf79bb2c7915207344b78
      with:
        version: v3.11.2

    - name: Install Python
      uses: actions/setup-python@13ae5bb136fac2878aff31522b9efb785519f984
      with:
        python-version: '3.11.2' 
  
    - name: Setup Helm chart testing
      uses: helm/chart-testing-action@afea100a513515fbd68b0e72a7bb0ae34cb62aec

    - name: Add Helm repositories
      run: |
        helm repo add cnpg https://cloudnative-pg.github.io/charts
        helm repo add strimzi https://strimzi.io/charts/
        helm repo update

    - name: Run chart-testing (list-changed)
      id: list-changed
      run: |
        changed=$(ct list-changed --config ct.yaml)
        if [[ -n "$changed" ]]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Run chart-testing (lint)
      if: steps.list-changed.outputs.changed == 'true'
      run: ct lint --config ct.yaml

    # - name: Create kind cluster
    #   if: steps.list-changed.outputs.changed == 'true'
    #   uses: helm/kind-action@v1.2.0

    # - name: Run chart-testing (install)
    #   run: ct install --config ct.yaml

  snyk:
    runs-on: ubuntu-24.04

    strategy:
      matrix:
        charts: ["studio", "rasa", "op-kits"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c
        with:
          fetch-depth: 0

      - name: Fetch history
        run: git fetch --prune

      - name: Install Helm 3
        uses: azure/setup-helm@5119fcb9089d432beecbf79bb2c7915207344b78
        with:
          version: v3.11.2

      - name: Add Helm repositories
        run: |
          helm repo add cnpg https://cloudnative-pg.github.io/charts
          helm repo add strimzi https://strimzi.io/charts/
          helm repo update

      - name: Update dependencies
        run: helm dependency build ./charts/${{ matrix.charts }}

      - name: Generate Helm template
        run: helm template ./charts/${{ matrix.charts }} --output-dir ./output

      - name: Scan chart with Snyk IAC
        uses: snyk/actions/iac@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          file: ./output/
          args: --report --severity-threshold=high

      
