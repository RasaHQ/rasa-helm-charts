# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

Helm charts for deploying Rasa products on Kubernetes:
- **`charts/studio/`** - Rasa Studio (v2.3.0): multi-component app with backend, web-client, keycloak, event-ingestion
- **`charts/rasa/`** - Rasa Pro (v2.0.2): main Rasa Pro server, action-server, duckling, rasa-pro-services
- **`charts/op-kits/`** - Operator Kits (v0.4.1): PostgreSQL (CloudNativePG), Kafka (Strimzi), Valkey operators

## Commands

### Lint and Template

```bash
# Lint a specific chart (strict mode)
helm lint --strict charts/<CHART>

# Lint only changed charts (CI-style)
ct lint --config ct.yaml

# List changed charts
ct list-changed --config ct.yaml

# Generate templates (for debugging/inspection)
helm template ./charts/<CHART> --output-dir ./output
```

### Dependencies

```bash
# Build dependencies after modifying Chart.yaml
helm dependency build ./charts/studio
helm dependency build ./charts/rasa
helm dependency build ./charts/op-kits
```

### Documentation (pre-commit)

```bash
# Run all pre-commit hooks (fixes EOL, regenerates README.md files)
pre-commit run --all-files

# Regenerate README.md files only
pre-commit run helm-docs --all-files
```

## Before Every Commit

1. Increment `version` in `charts/<CHART>/Chart.yaml` (required by CI)
2. Run `helm lint --strict charts/<CHART>`
3. Run `pre-commit run --all-files`
4. Commit the auto-generated `README.md` alongside your changes

## Key Conventions

### YAML Formatting (`lintconf.yaml`)
- No `---` document start markers
- Unix line endings, spaces (no tabs)
- Max 2 consecutive empty lines, none at file start/end
- Comments require a leading space, at least 2 spaces from content

### Values Documentation
Use `# --` prefix for comments that should appear in the auto-generated README:
```yaml
# -- Enable or disable this component
enabled: false
```
Never manually edit `README.md` — always edit `README.md.gotmpl` and `values.yaml` comments instead.

### Chart Version Bumps
- Patch (`1.3.2` → `1.3.3`): bug fixes
- Minor (`1.3.2` → `1.4.0`): new features
- Major (`1.3.2` → `2.0.0`): breaking changes

### Release Branch Versioning (`release/*`)
On `release/` branches, increment the version once and append `-rc.X`:
- Start: `2.0.2` → `2.0.3-rc.0`
- Each subsequent push: increment the rc counter (`-rc.1`, `-rc.2`, …)
- Before merging to `main`: remove the `-rc.X` suffix so the final version is `2.0.3`

CI blocks `-rc` suffixes on `main`.

### Secret References Pattern
```yaml
password:
  secretName: "my-secrets"
  secretKey: "SECRET_KEY"
```

### Component Enablement
Components are toggled via `<component>.enabled` flags in values. Studio conditionally deploys Rasa Pro via `rasa.enabled`.

## Architecture Notes

- Each chart's `templates/_helpers.tpl` defines naming helpers (`fullname`, `labels`, `selectorLabels`, `serviceAccountName`, `image`)
- Studio uses a custom `templates/_env.tpl` for shared environment variable templates and YAML anchors (`&dns_hostname`) for hostname consistency across ingresses
- Network policies follow a default-deny pattern: each chart includes `deny-all.yaml`, `allow-dns-access.yaml`, and `ingress-egress-from-kubelet.yaml`
- `README.md` files are auto-generated by helm-docs using `README.md.gotmpl` + `values.yaml` `# --` comments
- Studio's `Chart.lock` locks its Rasa dependency to a specific OCI version — run `helm dependency build` after any dependency changes
