apiVersion: kots.io/v1beta1
kind: Config
metadata:
  name: studio-config
spec:
  groups:
    - name: Container Images & API Keys
      description: >
        Here you will configure where container images are pulled from and what versions you use for components of Rasa Studio. You'll also set up your OpenAI API key for building bots.
      title: Container Images & API Keys
      items:
        - name: image_registry
          type: radio
          title: Image Registry
          help_text: You can choose whether to pull container images from Rasa's registry or use your own internal private registry.
          default: internal_registry
          items:
            - name: internal_registry
              title: Use Default Registry
              help_text: Select this option to pull container images from Rasa's registry.
            - name: external_registry
              title: Use Private Registry
              help_text: Select this option if you have your own private registry configured and you've pushed all the required images to it.
        - name: image_pull_secrets
          type: text
          title: Image Pull Secret Name
          help_text: To pull images from a private registry, you need to create a Kubernetes secret in this cluster to use for pulling images. Provide the name of this secret here. More information on how to create this secret can be found [here](https://rasa.com/docs/studio/deployment/installation-guide-replicated).
          when: '{{repl ConfigOptionEquals "image_registry" "external_registry"}}'
        - name: studio_repository
          type: text
          title: Studio Image Repository URL
          default: '{{repl (ConfigOptionEquals "image_registry" "internal_registry") | ternary (print (HasLocalRegistry | ternary LocalRegistryHost "registry.rasa.com") "/" (HasLocalRegistry | ternary LocalRegistryNamespace (print "proxy/" (LicenseFieldValue "appSlug") "/europe-west3-docker.pkg.dev/rasa-releases/studio/" ))) ""}}'
          help_text: URL of your private image repository for all of the Studio component images, without an image name.
          when: '{{repl ConfigOptionEquals "image_registry" "external_registry"}}'
        - name: studio_image_tag
          type: text
          title: Studio Version
          default: "1.14.0rc0-latest"
          help_text: The version of Rasa Studio you wish to use, which is used as the tag for the container image.
        - name: rasa_pro_repository
          type: text
          title: Rasa Pro Image Repository URL
          default: '{{repl (ConfigOptionEquals "image_registry" "internal_registry") | ternary (print (HasLocalRegistry | ternary LocalRegistryHost "registry.rasa.com") "/" (HasLocalRegistry | ternary LocalRegistryNamespace (print "proxy/" (LicenseFieldValue "appSlug") "/europe-west3-docker.pkg.dev/rasa-releases/rasa-pro" )) "/rasa-pro") ""}}'
          help_text: URL of your private image repository for Rasa Pro, used by Studio for training and running bots. Please specify full repository and image name in format `repository/image_name`.
          when: '{{repl ConfigOptionEquals "image_registry" "external_registry"}}'
          validation:
            regex:
              pattern: '[^\/]$'
              message: You have `/` at the end of your image URL. Please remove the `/` from the end in in format `repository/image_name`.
        - name: rasa_pro_image_tag
          type: text
          title: Rasa Pro Version
          default: "3.14.1-latest"
          help_text: The version of Rasa Pro you wish to use, which is used as the tag for the container image. To check what version of Rasa Pro you should use with your version of Rasa Studio, check [here](https://rasa.com/docs/reference/changelogs/compatibility-matrix/#studiopro-versions-compatibility)
        - name: openai_api_key
          type: text
          title: OpenAI API key
          default: ""
          required: true
          help_text: OpenAI API key to be used for training and running bots within Rasa Studio.
        - name: postgresql_image_tag
          type: text
          hidden: true
          default: 17.2.0-debian-12-r2 #16.4.0-debian-12-r8
          help_text: Postgesql version used in embedded database
        - name: replicated_sdk_image_tag
          type: text
          hidden: true
          default: 1.8.1
          help_text: Replicated SDK version
    - name: Accessing Rasa Studio
      description: >
        Here you will configure how you access Rasa Studio. Pick `Virtual Machine` if you are deploying on a VM, `Kubernetes` if you are deploying in Kubernetes cluster without an Ingress present, or `Do not install` if you already have a controller installed.
      title: Accessing Rasa Studio
      items:
        - name: ingress_hostname
          type: text
          title: Ingress DNS Hostname
          default: ""
          required: true
          help_text: The hostname for the VM you are installing on, which you will use to access Rasa Studio.
          validation:
            regex:
              pattern: '^(?:[^:/]+)?[^:/]+(?:\.[^:/]+)+(?:\/)?[^/]$'
              message: You have either `http(s)://` at the start of your hostname DNS or `/` at the end. Please input only hostname DNS.
        - name: connection_type
          type: dropdown
          title: Connection Type
          default: https
          items:
            - name: http
              title: http
            - name: https
              title: https
          help_text: Pick either `http` or `https` depending on how you expect to access Rasa Studio.
        - name: annotations
          type: textarea
          title: Annotations
          help_text: |
            Use this textarea to optionally provide annotations specific to your Kubernetes Ingress Controller.
            For example, `kubernetes.io/tls-acme: true`.
          default: ""
    - name: Model Training and Running Your Assistants
      description: >
        Configure how many assistants you are expecting to train and use with Studio.
      title: Model Training and Bot Runs
      items:
        - name: max_parallel_bot_runs
          type: text
          title: Maximum number of Assistants
          default: "10"
          help_text: Maximum number of Assistants to be able to create inside Studio.
        - name: max_parallel_trainings
          type: text
          title: Maximum number of simultaneous trainings
          default: "10"
          help_text: How many assistants do you expect to train simultaneously?. Have in mind that each assistant needs to use at least one training process.
    - name: Keycloak
      description: >
        Here you will configure Keycloak, the authentication solution used by Rasa Studio.
      title: Keycloak
      items:
        - name: keycloak_admin_username
          type: text
          title: Keycloak Admin Username
          default: kcadmin
          help_text: The admin username for Keycloak. This username is used to login to Keycloak admin console.
        - name: keycloak_admin_password
          type: text
          title: Keycloak Admin Password
          value: '{{repl RandomString 32}}'
          required: true
          help_text: The admin password for Keycloak. This password is used to login to Keycloak admin console. *DO NOT CHANGE* the password after installation.
        - name: keycloak_realm
          type: text
          title: Keycloak realm
          default: rasa-studio
          hidden: true
          help_text: Keycloak realm name
        - name: keycloak_api_username
          type: text
          title: Keycloak API username
          required: true
          default: realmadmin
          hidden: true
          help_text: These credentials are used by Studio Backend Server to communicate with Keycloak's user management module
        - name: keycloak_api_password
          type: password
          title: Keycloak API password
          value: '{{repl RandomString 32}}'
          required: true
          hidden: true
          help_text: These credentials are used by Studio Backend Server to communicate with Keycloak's user management module
        - name: keycloak_api_client_id
          type: text
          title: Keycloak API client ID
          default: admin-cli
          hidden: true
          help_text: Keycloak API client ID
        - name: keycloak_client_id
          type: text
          title: Keycloak Client ID
          default: rasa-studio-backend
          hidden: true
          help_text: Keycloak client id
        - name: keycloak_proxy
          type: text
          title: Keycloak proxy
          hidden: true
          default: "edge"
    - name: Database
      description: >
        Here you will configure how Rasa Studio connects to a database. Select Embedded Postgres to use an embedded Postgres database, meaning that you do not have to deploy and manage a Postgres database. We do not recommend this for production workloads. Select External Postgres to use an existing, external Postgres database.
      title: Database
      items:
        - name: postgres_type
          type: radio
          title: PostgreSQL
          default: embedded_postgres
          items:
            - name: embedded_postgres
              title: Embedded Postgres
            - name: external_postgres
              title: External Postgres
        - name: wait_for_it
          type: bool
          title: Wait for PostgreSQL to be ready
          default: '{{repl (ConfigOptionEquals "postgres_type" "embedded_postgres") | ternary "1" "0"}}'
          when: '{{repl ConfigOptionEquals "postgres_type" "embedded_postgres"}}'
          hidden: true
          help_text: Enable this if you are using Embedded PostgreSQL
        - name: database_host
          type: text
          title: Database Host
          required: true
          default: postgresql.postgresql.svc.cluster.local
          help_text: The database host name
          when: '{{repl ConfigOptionEquals "postgres_type" "external_postgres"}}'
        - name: database_username
          type: text
          title: Database Username
          required: true
          default: postgres
          when: '{{repl ConfigOptionEquals "postgres_type" "external_postgres"}}'
          help_text: The username to connect to your existing database.
        - name: database_password
          type: password
          title: Database Password
          value: '{{repl RandomString 32}}'
          required: true
          help_text: The password to connect to your existing database.
          when: '{{repl ConfigOptionEquals "postgres_type" "external_postgres"}}'
        - name: database_port
          type: text
          title: Database port
          required: true
          default: "5432"
          when: '{{repl ConfigOptionEquals "postgres_type" "external_postgres"}}'
          help_text: The port used to connect to your existing database.
        - name: studio_database
          type: text
          title: Studio Database Name
          default: studio
          help_text: The name of the database used by Rasa Studio.
          when: '{{repl ConfigOptionEquals "postgres_type" "external_postgres"}}'
        - name: keycloak_database
          type: text
          title: Keycloak Database Name
          default: keycloak
          help_text: The name of the database used by Keycloak, our authentication solution.
          when: '{{repl ConfigOptionEquals "postgres_type" "external_postgres"}}'
        - name: prefer_ssl
          type: text
          title: Prefer SSL
          default: "false"
          when: '{{repl ConfigOptionEquals "postgres_type" "external_postgres"}}'
          help_text: Set to `true`` if you want to use SSL for connecting to your existing database.
        - name: reject_unauthorized
          type: text
          title: Reject Unauthorized
          default: ""
          when: '{{repl ConfigOptionEquals "postgres_type" "external_postgres"}}'
          help_text: If `true` the server will reject db connection which is not present list of supplied CAs.
    - name: Kafka
      description: >
        Here you will configure how Rasa Studio uses Kafka. Select Embedded Kafka to use an embedded Kafka install, meaning that you do not have to deploy and manage your own Kafka instance. We do not recommend this for production workloads. Select External Kafka to use an existing, external Kafka deployment.
      title: Kafka
      items:
        - name: kafka_type
          type: radio
          title: Kafka
          default: embedded_kafka
          items:
            - name: embedded_kafka
              title: Embedded Kafka
            - name: external_kafka
              title: External Kafka
        - name: expose_kafka
          type: bool
          title: Expose Kafka outside the cluster.
          default: "0"
          when: '{{repl ConfigOptionEquals "kafka_type" "embedded_kafka"}}'
          help_text: Enable this if you want to expose Kafka externally through DNS. Use `<ingress dns hostname>:30002` to connect to it.
        - name: kafka_broker
          type: text
          title: Kafka Broker Address
          default: "kafka.kafka.svc.cluster.local:9092"
          help_text: The URL and port for your external Kafka deployment.
          when: '{{repl ConfigOptionEquals "kafka_type" "external_kafka"}}'
        - name: kafka_sasl_mechanism
          type: text
          title: Kafka SASL Mechanism
          default: PLAIN
          when: '{{repl ConfigOptionEquals "kafka_type" "external_kafka"}}'
          help_text: Supported values are `plain`, `SCRAM-SHA-256` or `SCRAM-SHA-512`. You can leave it empty if you are not using SASL.
        - name: kafka_username
          type: text
          title: Kafka SASL Username
          default: "kafka"
          when: '{{repl ConfigOptionEquals "kafka_type" "external_kafka"}}'
          help_text: Kafka SASL username
        - name: kafka_password
          type: password
          title: Kafka SASL password
          when: '{{repl ConfigOptionEquals "kafka_type" "external_kafka"}}'
          value: '{{repl RandomString 32}}'
          help_text: Kafka SASL password
        - name: kafka_group_id
          type: text
          title: Kafka Group ID
          default: "studio"
          when: '{{repl ConfigOptionEquals "kafka_type" "external_kafka"}}'
          help_text: This is the Kafka group ID that Studio can use to receive a copy of all the Rasa Pro events streamed to the topic. It should be unique for Studio.
        - name: kafka_topic
          type: text
          title: Kafka Topic
          default: rasa-events
          when: '{{repl ConfigOptionEquals "kafka_type" "external_kafka"}}'
          help_text: Kafka topic to which to Rasa Pro assistant will publish events. Make sure that you pre-create these on your own.
        - name: kafka_dlq_topic
          type: text
          title: Kafka DLQ topic
          default: rasa-events-dlq
          when: '{{repl ConfigOptionEquals "kafka_type" "external_kafka"}}'
          help_text: Kafka topic to which unprocessed Rasa Pro assistant events will be pushed by Studio. Make sure that you pre-create these on your own.
        - name: rasa_assistant_topic
          type: text
          title: Rasa Assistant Topic
          default: rasa-assistant
          when: '{{repl ConfigOptionEquals "kafka_type" "external_kafka"}}'
        - name: rasa_core_events_topic
          type: text
          title: Rasa Assistant Core Events Topic
          default: rasa-core-events
          when: '{{repl ConfigOptionEquals "kafka_type" "external_kafka"}}'
        - name: kafka_security_protocol
          type: text
          title: Kafka Security Protocol
          default: SASL_PLAINTEXT
          when: '{{repl ConfigOptionEquals "kafka_type" "external_kafka"}}'
          help_text: The security protocol used by your existing Kafka deployment.
        - name: kafka_ssl
          type: text
          title: Kafka Enable SSL
          default: ""
          when: '{{repl ConfigOptionEquals "kafka_type" "external_kafka"}}'
          help_text: Set to `true` if you want to use SSL with your existing Kafka deployment.
        - name: kafka_custom_ssl
          type: text
          title: Kafka Custom SSL
          default: ""
          when: '{{repl ConfigOptionEquals "kafka_type" "external_kafka"}}'
          help_text: Set to `true` if you want to use SSL with custom certificates.
        - name: kafka_ca_file
          type: text
          title: Kafka CA file
          default: ""
          when: '{{repl ConfigOptionEquals "kafka_custom_ssl" "true"}}'
          help_text: Path to the CA file
        - name: kafka_key_file
          type: text
          title: Kafka key file
          default: ""
          when: '{{repl ConfigOptionEquals "kafka_custom_ssl" "true"}}'
          help_text: Path to the client key file
        - name: kafka_cert_file
          type: text
          title: Kafka certificate file
          default: ""
          when: '{{repl ConfigOptionEquals "kafka_custom_ssl" "true"}}'
          help_text: Path to the client certificate file
        - name: kafka_reject_unauthorized
          type: text
          title: Kafka reject unauthorized
          default: ""
          when: '{{repl ConfigOptionEquals "kafka_custom_ssl" "true"}}'
          help_text: Defaults to true, the server certificate is verified against the list of supplied CA
        - name: node_tls_reject_unauthorized
          type: text
          title: Node TLS reject unauthorized
          default: ""
          when: '{{repl ConfigOptionEquals "kafka_type" "external_kafka"}}'
    - name: Advanced Settings
      description: >
        Here you will optionally configure Kubernetes resource limits and requests for the components of Rasa Studio. If you're not sure what this is, you can safely ignore it.
      title: Resource Management
      items:
        - name: set_backend_resources
          type: bool
          title: Configure Backend resources
          default: "0"
          help_text: Check this option if you want to configure resource requests/limits for Backend deployment
        - name: set_backend_limits_cpu
          type: text
          title: Backend CPU limit
          help_text: Configure Backend resource limit for CPU
          when: '{{repl ConfigOptionEquals "set_backend_resources" "1"}}'
        - name: set_backend_limits_memory
          type: text
          title: Backend Memory limit
          help_text: Configure Backend resource limit for Memory
          when: '{{repl ConfigOptionEquals "set_backend_resources" "1"}}'
        - name: set_backend_requests_cpu
          type: text
          title: Backend CPU requests
          help_text: Configure Backend resource requests for CPU
          when: '{{repl ConfigOptionEquals "set_backend_resources" "1"}}'
        - name: set_backend_requests_memory
          type: text
          title: Backend Memory requests
          help_text: Configure Backend resource requests for Memory
          when: '{{repl ConfigOptionEquals "set_backend_resources" "1"}}'
        - name: set_webclient_resources
          type: bool
          title: Configure Web client resources
          default: "0"
          help_text: Check this option if you want to configure resource requests/limits for Web client deployment
        - name: set_webclient_limits_cpu
          type: text
          title: Web client CPU limit
          help_text: Configure Web client resource limit for CPU
          when: '{{repl ConfigOptionEquals "set_webclient_resources" "1"}}'
        - name: set_webclient_limits_memory
          type: text
          title: Web client Memory limit
          help_text: Configure Web client resource limit for Memory
          when: '{{repl ConfigOptionEquals "set_webclient_resources" "1"}}'
        - name: set_webclient_requests_cpu
          type: text
          title: Web client CPU requests
          help_text: Configure Web client resource requests for CPU
          when: '{{repl ConfigOptionEquals "set_webclient_resources" "1"}}'
        - name: set_webclient_requests_memory
          type: text
          title: Web client Memory requests
          help_text: Configure Web client resource requests for Memory
          when: '{{repl ConfigOptionEquals "set_webclient_resources" "1"}}'
        - name: set_eventingestion_resources
          type: bool
          title: Configure Event ingestion resources
          default: "0"
          help_text: Check this option if you want to configure resource requests/limits for Event ingestion deployment
        - name: set_eventingestion_limits_cpu
          type: text
          title: Event ingestion CPU limit
          help_text: Configure Event ingestion resource limit for CPU
          when: '{{repl ConfigOptionEquals "set_eventingestion_resources" "1"}}'
        - name: set_eventingestion_limits_memory
          type: text
          title: Event ingestion Memory limit
          help_text: Configure Event ingestion resource limit for Memory
          when: '{{repl ConfigOptionEquals "set_eventingestion_resources" "1"}}'
        - name: set_eventingestion_requests_cpu
          type: text
          title: Event ingestion CPU requests
          help_text: Configure Event ingestion resource requests for CPU
          when: '{{repl ConfigOptionEquals "set_eventingestion_resources" "1"}}'
        - name: set_eventingestion_requests_memory
          type: text
          title: Event ingestion Memory requests
          help_text: Configure Event ingestion resource requests for Memory
          when: '{{repl ConfigOptionEquals "set_eventingestion_resources" "1"}}'
        - name: set_keycloak_resources
          type: bool
          title: Configure Keycloak resources
          default: "0"
          help_text: Check this option if you want to configure resource requests/limits for Keycloak deployment
        - name: set_keycloak_limits_cpu
          type: text
          title: Keycloak CPU limit
          help_text: Configure Keycloak resource limit for CPU
          when: '{{repl ConfigOptionEquals "set_keycloak_resources" "1"}}'
        - name: set_keycloak_limits_memory
          type: text
          title: Keycloak Memory limit
          help_text: Configure Keycloak resource limit for Memory
          when: '{{repl ConfigOptionEquals "set_keycloak_resources" "1"}}'
        - name: set_keycloak_requests_cpu
          type: text
          title: Keycloak CPU requests
          help_text: Configure Keycloak resource requests for CPU
          when: '{{repl ConfigOptionEquals "set_keycloak_resources" "1"}}'
        - name: set_keycloak_requests_memory
          type: text
          title: Keycloak Memory requests
          help_text: Configure Keycloak resource requests for Memory
          when: '{{repl ConfigOptionEquals "set_keycloak_resources" "1"}}'
