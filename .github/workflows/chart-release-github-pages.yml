name: Release Helm Charts to GitHub Pages (PR flow)

on:
  push:
    branches: [ main ]
    paths:
      - charts/**
      - '!replicated/**'
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

env:
  PAGES_BRANCH: ci/helm-index
  INDEX_PATH: charts/index.yaml

jobs:
  release-charts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.CHART_RELEASER_PAT }}

      - name: Configure git identity
        run: |
          git config user.name "chart-bot"
          git config user.email "chart-bot@users.noreply.github.com"

      # Ensure ci/helm-index exists AND has charts/ so CR_PAGES_INDEX_PATH can be written
      - name: Ensure ${PAGES_BRANCH} branch exists with charts/
        run: |
          set -euo pipefail
          if git ls-remote --exit-code --heads origin "${PAGES_BRANCH}" >/dev/null 2>&1; then
            echo "${PAGES_BRANCH} already exists."
            git fetch origin "${PAGES_BRANCH}:${PAGES_BRANCH}"
            git checkout "${PAGES_BRANCH}"
            mkdir -p charts
            if ! git ls-files --error-unmatch charts >/dev/null 2>&1; then
              touch charts/.keep
              git add charts/.keep
              git commit -m "chore: ensure charts/ exists for index path"
              git push origin "${PAGES_BRANCH}"
            fi
            git checkout -f -
          else
            echo "Creating ${PAGES_BRANCH}â€¦"
            git checkout --orphan "${PAGES_BRANCH}"
            git reset --hard
            mkdir -p charts
            echo "# Helm index branch" > README.md
            touch charts/.keep
            git add README.md charts/.keep
            git commit -m "chore: init ${PAGES_BRANCH} (add charts/ for index)"
            git push origin "${PAGES_BRANCH}"
            git checkout -f main
          fi

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.15.2

      # Package charts, upload to Releases, and write charts/index.yaml to ci/helm-index
      - name: Run chart-releaser (packages + index â†’ ${PAGES_BRANCH})
        uses: helm/chart-releaser-action@v1.7.0
        with:
          charts_dir: charts
        env:
          CR_TOKEN: ${{ secrets.CHART_RELEASER_PAT }}
          CR_PAGES_BRANCH: ${{ env.PAGES_BRANCH }}
          CR_PAGES_INDEX_PATH: ${{ env.INDEX_PATH }}
          CR_GENERATE_RELEASE_NOTES: "true"
          CR_SKIP_EXISTING: "true"

      # Fetch the updated index.yaml from ci/helm-index
      - name: Fetch updated index.yaml from ${PAGES_BRANCH}
        id: fetch_index
        run: |
          set -euo pipefail
          if git ls-remote --exit-code --heads origin "${PAGES_BRANCH}" >/dev/null 2>&1; then
            git fetch origin "${PAGES_BRANCH}:${PAGES_BRANCH}"
            git checkout "${PAGES_BRANCH}" -- "${INDEX_PATH}"
          else
            echo "no_index=true" >> $GITHUB_OUTPUT
          fi

      # Open/update a PR into main with only charts/index.yaml
      - name: Create PR for index.yaml
        if: steps.fetch_index.outputs.no_index != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.CHART_RELEASER_PAT }}
          commit-message: "chore(helm): update ${INDEX_PATH}"
          title: "chore(helm): update Helm index"
          branch: ci/update-helm-index
          base: main
          delete-branch: true
          labels: |
            automated
          body: |
            ## ðŸ“¦ Helm Repository Index Update

            This PR updates the Helm repository index with newly released charts.
            Packages are stored as GitHub Release assets. Once merged, Pages will serve the updated index.

            Once merged, https://helm.rasa.com/charts will serve the updated index.

          add-paths: |
            charts/index.yaml
